name: Build & Publish Hugo Image

on:
  push:
    branches: [ main ]
    # Only rebuild when content/theme/config changes (adjust as you like)
    paths:
      - 'content/**'
      - 'layouts/**'
      - 'static/**'
      - 'assets/**'
      - 'themes/**'
      - 'config*'
      - 'hugo*'
      - 'Dockerfile'
      - '.github/workflows/publish.yml'
#   # Optional: publish on tags for release images
#   tags:
#     - 'v*.*.*'

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write      # required to push to GHCR
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}          # e.g. ghcr.io/owner/repo
      # Optional Hugo baseURL; override per-env if you want
      HUGO_BASEURL: https://www.moyer.wtf/
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect image metadata
        id: meta
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          {
            echo "image=${IMAGE}"
            echo "tags<<EOF"
            echo "${IMAGE}:latest"
            echo "${IMAGE}:${GITHUB_SHA}"
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build image
        run: |
          docker build \
            --build-arg HUGO_BASEURL=${{ env.HUGO_BASEURL }} \
            --tag "${{ steps.meta.outputs.image }}:latest" \
            --tag "${{ steps.meta.outputs.image }}:${GITHUB_SHA}" \
            .

      - name: Push tags
        run: |
          while IFS= read -r tag; do
            docker push "$tag"
          done <<< "${{ steps.meta.outputs.tags }}"
